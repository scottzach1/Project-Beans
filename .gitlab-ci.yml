stages:
  - Lint
  - Build
  - Test
  - Deploy

# https://github.com/markdownlint/markdownlint/blob/master/docs/configuration.md
# https://github.com/markdownlint/markdownlint/blob/master/docs/RULES.md
markdownlint:
  stage: Lint
  tags:
    - docker
  image: pipelinecomponents/markdownlint:latest
  script:
    - mdl --style all --warnings --rules ~MD001,~MD004,~MD005,~MD006,~MD007,~MD009,~MD012,~MD013,~MD022,~MD024,~MD025,~MD029,~MD032,~MD033,~MD034,~MD036 .
  allow_failure: true

cpplint:
  image: python:latest
  stage: Lint
  script:
    - pip install cpplint
    - cpplint --filter=-legal --recursive */*
  tags:
    - docker
  allow_failure: true

build:
  stage: Build
  tags:
    - shell
  script:
    - echo "static analysis"
    - exit 0
  allow_failure: true

test-drc:
  stage: Test
  tags:
    - drc
  image: productize/kicad-automation-scripts:latest
  script:
    - export DISPLAY=:0
    - python -m kicad-automation.pcbnew_automation.run_drc ./hardware_package/avionics_pcb/testing/KiCad.kicad_pcb .output
  allow_failure: true

unit-test:
    stage: Test
    image: gcc
    script:
        - apt-get update
        - apt-get install -y gcovr
        - cd software_package/src/tests #TODO: Update path later on if we need to
        - mkdir coverage-files
        - g++ *-tests.cpp catch-runner.cpp -o tests --coverage -std=c++11
        - ./tests
        - gcov *-tests.cpp
        - gcovr -r . -e catch.hpp --html -o coverage-files/coverage.html --html-details
    tags:
        - docker
    artifacts:
        paths:
            - software_package/src/tests/coverage-files/coverage.html
            - software_package/src/tests/coverage-files/coverage.*-tests.cpp.html
        untracked: false
        expire_in: 30 days
    allow_failure: true

deploy:
  stage: Deploy
  tags:
    - shell
  script:
    - echo "deploy"
    - exit 0
  allow_failure: true
